<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SRM CAMPUS MARKETPLACE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .view { display: none; }
        .view.active { display: block; }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Header -->
    <header class="bg-white shadow-md">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="text-2xl font-bold text-gray-800 cursor-pointer" id="logo">SRM CAMPUS MARKETPLACE</div>
            <div class="flex items-center space-x-4">
                <button id="nav-login" class="px-4 py-2 text-gray-700 hover:text-blue-500">Login</button>
                <button id="nav-register" class="px-4 py-2 text-white bg-blue-600 rounded-md hover:bg-blue-700">Register</button>
                <div id="user-actions" class="hidden items-center space-x-4">
                    <button id="nav-my-listings" class="px-4 py-2 text-gray-700 hover:text-blue-500">My Listings</button>
                    <button id="nav-create-listing" class="px-4 py-2 text-white bg-green-600 rounded-md hover:bg-green-700">Create Listing</button>
                    <button id="nav-logout" class="px-4 py-2 text-gray-700 hover:text-red-500">Logout</button>
                </div>
            </div>
        </nav>
    </header>

    <main class="container mx-auto p-6">
        <!-- Marketplace View -->
        <div id="main-view" class="view active">
            <div id="tabs-container" class="flex space-x-4 border-b mb-6">
                <button id="tab-all" class="py-2 px-1 border-b-2 border-blue-500 text-blue-600 font-semibold">All Listings</button>
                <button id="tab-my-listings" class="py-2 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-semibold">My Listings</button>
            </div>
             <h1 id="view-title" class="text-3xl font-bold mb-6 text-gray-800">All Listings</h1>
             <div id="listings-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                <!-- Listing cards will be injected here by JavaScript -->
            </div>
        </div>

        <!-- Login View -->
        <div id="login-view" class="view">
            <div class="max-w-md mx-auto bg-white p-8 rounded-lg shadow-lg">
                <h2 class="text-2xl font-bold mb-6 text-center">Login</h2>
                <form id="login-form">
                    <div class="mb-4">
                        <label for="login-email" class="block text-gray-700 mb-2">Email</label>
                        <input type="email" id="login-email" class="w-full px-3 py-2 border rounded-md" required>
                    </div>
                    <div class="mb-6">
                        <label for="login-password" class="block text-gray-700 mb-2">Password</label>
                        <input type="password" id="login-password" class="w-full px-3 py-2 border rounded-md" required>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700">Login</button>
                </form>
            </div>
        </div>

        <!-- Register View -->
        <div id="register-view" class="view">
             <div class="max-w-md mx-auto bg-white p-8 rounded-lg shadow-lg">
                <h2 class="text-2xl font-bold mb-6 text-center">Create Account</h2>
                <form id="register-form">
                    <div class="grid grid-cols-2 gap-4">
                         <div class="mb-4">
                            <label for="register-firstname" class="block text-gray-700 mb-2">First Name</label>
                            <input type="text" id="register-firstname" class="w-full px-3 py-2 border rounded-md" required>
                        </div>
                        <div class="mb-4">
                            <label for="register-lastname" class="block text-gray-700 mb-2">Last Name</label>
                            <input type="text" id="register-lastname" class="w-full px-3 py-2 border rounded-md" required>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label for="register-phone" class="block text-gray-700 mb-2">Phone Number</label>
                        <input type="tel" id="register-phone" class="w-full px-3 py-2 border rounded-md" required>
                    </div>
                    <div class="mb-4">
                        <label for="register-email" class="block text-gray-700 mb-2">Email</label>
                        <input type="email" id="register-email" class="w-full px-3 py-2 border rounded-md" required>
                    </div>
                    <div class="mb-6">
                        <label for="register-password" class="block text-gray-700 mb-2">Password (min 6 characters)</label>
                        <input type="password" id="register-password" class="w-full px-3 py-2 border rounded-md" minlength="6" required>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700">Register</button>
                </form>
            </div>
        </div>

        <!-- Create Listing View -->
        <div id="create-listing-view" class="view">
             <div class="max-w-lg mx-auto bg-white p-8 rounded-lg shadow-lg">
                <h2 class="text-2xl font-bold mb-6 text-center">Create a New Listing</h2>
                <form id="create-listing-form">
                    <div class="mb-4">
                        <label for="listing-title" class="block text-gray-700 mb-2">Title</label>
                        <input type="text" id="listing-title" class="w-full px-3 py-2 border rounded-md" required>
                    </div>
                    <div class="mb-4">
                        <label for="listing-description" class="block text-gray-700 mb-2">Description</label>
                        <textarea id="listing-description" rows="4" class="w-full px-3 py-2 border rounded-md" required></textarea>
                    </div>
                     <div class="grid grid-cols-2 gap-4">
                        <div class="mb-4">
                            <label for="listing-type" class="block text-gray-700 mb-2">Listing Type</label>
                            <select id="listing-type" class="w-full px-3 py-2 border rounded-md bg-white">
                                <option value="SALE">For Sale</option>
                                <option value="RENTAL">For Rent</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label for="listing-price" class="block text-gray-700 mb-2">Price (INR)</label>
                            <input type="number" id="listing-price" step="0.01" min="0" class="w-full px-3 py-2 border rounded-md" required>
                        </div>
                    </div>
                    <button type="submit" class="w-full bg-green-600 text-white py-2 rounded-md hover:bg-green-700">Create Listing</button>
                     <!-- --- NEW BUTTON --- -->
                     <button type="button" id="back-to-marketplace-btn" class="w-full mt-4 text-center text-gray-600 hover:text-blue-600 py-2 rounded-md">Back to Marketplace</button>
                </form>
            </div>
        </div>
        
        <!-- Message Modal -->
        <div id="message-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white p-6 rounded-lg shadow-xl text-center w-11/12 max-w-sm">
                <p id="modal-message-text" class="mb-4 text-lg"></p>
                <button id="modal-close-btn" class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700">OK</button>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const API_URL = 'http://localhost:8080/api';

            const views = document.querySelectorAll('.view');
            const logo = document.getElementById('logo');
            const navLoginBtn = document.getElementById('nav-login');
            const navRegisterBtn = document.getElementById('nav-register');
            const navCreateListingBtn = document.getElementById('nav-create-listing');
            const navLogoutBtn = document.getElementById('nav-logout');
            const userActionsDiv = document.getElementById('user-actions');
            const listingsGrid = document.getElementById('listings-grid');
            const messageModal = document.getElementById('message-modal');
            const modalMessageText = document.getElementById('modal-message-text');
            const modalCloseBtn = document.getElementById('modal-close-btn');
            const navMyListingsBtn = document.getElementById('nav-my-listings');
            const tabAllBtn = document.getElementById('tab-all');
            const tabMyListingsBtn = document.getElementById('tab-my-listings');
            const viewTitle = document.getElementById('view-title');
            const tabsContainer = document.getElementById('tabs-container');
            // --- NEW: Get back button ---
            // Note: We add the listener after showing the form view

            let currentUserEmail = localStorage.getItem('currentUserEmail');
            let currentListings = []; 
            let currentViewTab = 'all'; 

            const showView = (viewId) => {
                views.forEach(view => view.classList.remove('active'));
                const viewToShow = document.getElementById(viewId);
                viewToShow.classList.add('active');
                
                // --- NEW: Add listener AFTER showing the create listing view ---
                if (viewId === 'create-listing-view') {
                    const backBtn = document.getElementById('back-to-marketplace-btn');
                    if (backBtn) { // Check if button exists before adding listener
                         backBtn.addEventListener('click', () => {
                            showView('main-view');
                            updateTabs(); // Ensure correct tab is highlighted
                            renderListings(); // Re-render based on current tab
                        }, { once: true }); // Use { once: true } if you only need it once per view show
                    }
                }
            };

            const showModal = (message) => {
                modalMessageText.textContent = message;
                messageModal.classList.remove('hidden');
            };

            const hideModal = () => {
                messageModal.classList.add('hidden');
            };
            
            const handleApiError = (error, context) => {
                console.error(`Error in ${context}:`, error);
                const errorMessage = (error instanceof TypeError && error.message === 'Failed to fetch') 
                    ? 'Connection Error: Could not connect to the backend. Please ensure the Java server is running.'
                    : (error.message || `An unknown error occurred during ${context}.`);
                showModal(errorMessage);
            };

            const updateNav = () => {
                if (currentUserEmail) {
                    navLoginBtn.classList.add('hidden');
                    navRegisterBtn.classList.add('hidden');
                    userActionsDiv.classList.remove('hidden');
                    userActionsDiv.classList.add('flex');
                    tabsContainer.style.display = 'flex'; 
                } else {
                    navLoginBtn.classList.remove('hidden');
                    navRegisterBtn.classList.remove('hidden');
                    userActionsDiv.classList.add('hidden');
                    userActionsDiv.classList.remove('flex');
                    tabsContainer.style.display = 'none'; 
                }
            };

            const updateTabs = () => {
                if (!currentUserEmail) {
                    tabsContainer.style.display = 'none';
                    return;
                }
                tabsContainer.style.display = 'flex';
                
                tabAllBtn.classList.remove('border-blue-500', 'text-blue-600');
                tabAllBtn.classList.add('border-transparent', 'text-gray-500');
                tabMyListingsBtn.classList.remove('border-blue-500', 'text-blue-600');
                tabMyListingsBtn.classList.add('border-transparent', 'text-gray-500');

                if (currentViewTab === 'all') {
                    tabAllBtn.classList.add('border-blue-500', 'text-blue-600');
                    tabAllBtn.classList.remove('border-transparent', 'text-gray-500');
                    viewTitle.textContent = "All Listings";
                } else {
                    tabMyListingsBtn.classList.add('border-blue-500', 'text-blue-600');
                    tabMyListingsBtn.classList.remove('border-transparent', 'text-gray-500');
                    viewTitle.textContent = "My Listings";
                }
            }

            const fetchListings = async () => {
                try {
                    const response = await fetch(`${API_URL}/listings`);
                    if (!response.ok) throw new Error('Failed to fetch listings');
                    currentListings = await response.json(); 
                    renderListings(); 
                } catch (error) {
                    handleApiError(error, 'fetching listings');
                }
            };

            const renderListings = () => {
                listingsGrid.innerHTML = '';
                
                const listingsToDisplay = currentViewTab === 'all' 
                    ? currentListings 
                    : currentListings.filter(l => currentUserEmail && l.sellerEmail && currentUserEmail.toLowerCase() === l.sellerEmail.toLowerCase());

                if (!listingsToDisplay || listingsToDisplay.length === 0) {
                    listingsGrid.innerHTML = `<p class="text-gray-500 col-span-full text-center">${currentViewTab === 'my' ? 'You have not created any listings yet.' : 'No listings found.'}</p>`;
                    return;
                }
                
                listingsToDisplay.forEach(listing => {
                    const isOwner = currentUserEmail && listing.sellerEmail && currentUserEmail.toLowerCase() === listing.sellerEmail.toLowerCase();
                    
                    let deleteButtonHtml = '';
                    if (isOwner && currentViewTab === 'my') {
                        deleteButtonHtml = `
                            <div class="mt-4 pt-4 border-t text-right">
                                <button data-listing-id="${listing.id}" class="delete-btn text-sm text-red-500 hover:text-red-700 font-semibold">Delete Listing</button>
                            </div>
                        `;
                    }

                    const listingCard = `
                        <div class="bg-white rounded-lg shadow-md overflow-hidden transform hover:-translate-y-1 transition-transform duration-300">
                            <div class="p-4">
                                <h3 class="font-bold text-lg mb-2">${listing.title}</h3>
                                <p class="text-gray-600 text-sm mb-4">${listing.description.substring(0, 100)}...</p>
                                <div class="text-sm text-gray-800 font-semibold mb-2">
                                    <span>Contact:</span> ${listing.sellerPhoneNumber}
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-xl font-bold text-blue-600">₹${listing.price.toFixed(2)}</span>
                                    <span class="text-xs font-semibold px-2 py-1 rounded-full ${listing.listingType === 'SALE' ? 'bg-green-200 text-green-800' : 'bg-yellow-200 text-yellow-800'}">${listing.listingType}</span>
                                </div>
                                <div class="text-xs text-gray-500 mt-2">By ${listing.sellerName}</div>
                                ${deleteButtonHtml}
                            </div>
                        </div>
                    `;
                    listingsGrid.innerHTML += listingCard;
                });
            };

            // --- Event Listeners ---

            logo.addEventListener('click', () => {
                currentViewTab = 'all'; 
                updateTabs();
                showView('main-view'); 
                renderListings(); 
            });
            navLoginBtn.addEventListener('click', () => showView('login-view'));
            navRegisterBtn.addEventListener('click', () => showView('register-view'));
            navCreateListingBtn.addEventListener('click', () => showView('create-listing-view'));
            
            navLogoutBtn.addEventListener('click', () => {
                localStorage.removeItem('currentUserEmail');
                currentUserEmail = null;
                currentViewTab = 'all'; 
                updateNav();
                updateTabs();
                showView('main-view');
                fetchListings(); 
                showModal('You have been logged out.');
            });

            modalCloseBtn.addEventListener('click', hideModal);

            tabAllBtn.addEventListener('click', () => {
                currentViewTab = 'all';
                updateTabs();
                renderListings();
            });

            tabMyListingsBtn.addEventListener('click', () => {
                if (!currentUserEmail) return; 
                currentViewTab = 'my';
                updateTabs();
                renderListings();
            });
            
             navMyListingsBtn.addEventListener('click', () => {
                if (!currentUserEmail) return;
                currentViewTab = 'my';
                updateTabs();
                showView('main-view'); 
                renderListings(); 
            });

            document.getElementById('login-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                
                try {
                    const response = await fetch(`${API_URL}/auth/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password })
                    });
                    const responseText = await response.text();
                    if (!response.ok) throw new Error(responseText || 'Login failed');
                    
                    currentUserEmail = responseText;
                    localStorage.setItem('currentUserEmail', currentUserEmail);
                    currentViewTab = 'all'; 
                    updateNav();
                    updateTabs();
                    showView('main-view');
                    document.getElementById('login-form').reset();
                    fetchListings(); 
                } catch (error) {
                    handleApiError(error, 'login');
                }
            });

            document.getElementById('register-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const firstName = document.getElementById('register-firstname').value;
                const lastName = document.getElementById('register-lastname').value;
                const phoneNumber = document.getElementById('register-phone').value;
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                
                try {
                     const response = await fetch(`${API_URL}/auth/register`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ firstName, lastName, email, password, phoneNumber })
                    });
                    const responseText = await response.text();
                    if (!response.ok) throw new Error(responseText || 'Registration failed');
                    
                    showModal('Registration successful! Please log in.');
                    showView('login-view');
                    document.getElementById('register-form').reset();
                } catch (error) {
                    handleApiError(error, 'registration');
                }
            });

            document.getElementById('create-listing-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentUserEmail) {
                    showModal('You must be logged in to create a listing.');
                    return;
                }

                const title = document.getElementById('listing-title').value;
                const description = document.getElementById('listing-description').value;
                const listingType = document.getElementById('listing-type').value;
                const price = parseFloat(document.getElementById('listing-price').value);

                try {
                    const response = await fetch(`${API_URL}/listings`, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'X-User-Email': currentUserEmail
                        },
                        body: JSON.stringify({ title, description, listingType, price })
                    });
                    if (!response.ok) {
                         const errorText = await response.text();
                         throw new Error(errorText || 'Failed to create listing');
                    }
                    
                    showModal('Listing created successfully!');
                    currentViewTab = 'my'; 
                    updateTabs();
                    showView('main-view');
                    fetchListings(); 
                    document.getElementById('create-listing-form').reset();
                } catch (error) {
                     handleApiError(error, 'listing creation');
                }
            });
            
            listingsGrid.addEventListener('click', async (e) => {
                if (e.target.classList.contains('delete-btn')) {
                    const listingId = e.target.dataset.listingId;
                    
                    const confirmed = confirm('Are you sure you want to delete this listing? This action cannot be undone.'); 
                    
                    if (confirmed) {
                        try {
                            const response = await fetch(`${API_URL}/listings/${listingId}`, {
                                method: 'DELETE',
                                headers: {
                                    'X-User-Email': currentUserEmail
                                }
                            });

                            if (!response.ok) {
                                const errorText = await response.text();
                                throw new Error(errorText || 'Failed to delete listing');
                            }
                            
                            showModal('Listing deleted successfully.');
                            fetchListings(); 

                        } catch (error) {
                            handleApiError(error, 'deleting listing');
                        }
                    }
                }
            });

            const initializeApp = () => {
                updateNav();
                updateTabs();
                showView('main-view'); 
                fetchListings();
            };

            initializeApp();
        });
    </script>
</body>
</html>


